== Publishing JBDS Installers to EA ==

# TODO in product/features/com.jboss.jbds.product.feature/p2.inf
# TODO when releasing GA make sure to :%s/development/stable/g and :%s/7.0-staging/7.0/g

1. ssh to wallace.redhat.com, then fetch installers & sources zip:

  screen

  version=7.0.0.GA
  version2=7.0.0.GA; # a, b, c, ...
  dev=10.16.88.146; # dev01.mw.lab.eng.bos.redhat.com
  cd /mnt/devstudio/earlyaccess/builds/development/
  mkdir -p /mnt/devstudio/earlyaccess/builds/development/${version}
  touch ${version}-eap__No.eap.builds.will.be.released
  rsync -aPrz --rsh=ssh --exclude="*-eap-*" nboldt@${dev}:~/RHDS/builds/development/${version2}.installer/jbdevstudio-product* ${version}/

  # Add an .htaccess file w/ password to the *-eap folder, and if necessary, update the .htpasswd file w/ a new password (use `htpasswd` to generate the hashed password).
  # cp /mnt/devstudio/earlyaccess/builds/development/7.0.*-eap/.htaccess /mnt/devstudio/earlyaccess/builds/development/${version2}-eap/

  # clean out old installers & update sites from previous milestones; rename update sites from "a,b,c" to ""
  version=7.0.0.GA
  version2=7.0.0.GA; # a, b, c, ...
  cd /mnt/devstudio/updates/7.0.0/
  if [[ ${version} != ${version2} ]]; then 
    mv ${version}.core ${version}.core.DELETEME
    mv ${version}.target-platform ${version}.target-platform.DELETEME
    mv ${version2}.core ${version}.core
    mv ${version2}.target-platform ${version}.target-platform
  fi
  # TODO: do not run this next line if the above step fails!
  rm -fr ${version}?.core ${version}?.target-platform *.DELETEME

  # only applies if we staged installers for QE (eg., CR builds?); if you did not, then skip this step
  #cd /mnt/devstudio/earlyaccess/builds/development
  #if [[ ${version} != ${version2} ]]; then 
  #  mv ${version} ${version}.DELETEME
  #  mv ${version2} ${version}
  #fi  
  #rm -fr *.DELETEME

2. rename milestones from Foo1b to Foo1; fix html pages in 7.0-staging

  # NOTE: ~/truu/devstudio.jboss.com is a symlink on my local machine to this folder in github: https://github.com/jbdevstudio/jbdevstudio-website/tree/master/content
  # "gw1" uses special aliases/scripts/shortcuts. Basically, we want to follow correct github workflows so that commits are pushed to user's fork, then later pull-requested (and the PR applied)
  # "gw2" will create the PR, "gw3" will apply it, and "gw4" will delete the topic branch locally and in my fork
  # the 4 steps are captured here: https://gist.github.com/nickboldt/4111850
  # "stat" is short for "git status"; "gd" is short for "git diff"; "ga" is short for "git add"

  cd ~/truu/devstudio.jboss.com/updates/7.0-staging
  version=7.0.0.GA
  version2=7.0.0.GA; # a, b, c, ...
  now=`date +%s000`
  for d in composite*.xml index.html central/core/index.html ; do
    sed -i -e "s#${version2}#${version}#g" $d
    sed -i -e "s#<property name='p2.timestamp' value='[0-9]\+'/>#<property name='p2.timestamp' value='${now}'/>#g" $d
  done

  # commit to github   
  topic="release-${version2}";branch=master; gw1
  ci "rename ${version2} to ${version}" .
  gw2;gw3;gw4

3. Update http://svn.jboss.org/repos/devstudio/trunk/devstudio.jboss.com/earlyaccess/*.html

  alias   ga='git add'
  alias   stat='git status'
  alias   gd='git diff --color=always -w'
  alias   scpr='rsync -aPrz --rsh=ssh'
  alias   ci='git commit -m'
  
  version=7.0.0.GA
  version2=7.0.0.GA; # a, b, ...
  cd ~/truu/devstudio.jboss.com/earlyaccess
  wget http://www.qa.jboss.com/binaries/RHDS/builds/development/${version2}.installer/${version}.html
  echo "<html><head></head><body onload=\"document.location.href='../${version}.html'\"></body></html>" > 7.0/index.html

  # commit to github   
  topic="release-${version}";branch=master; gw1
  ga ${version}.html; ci "new early access build - ${version} (${version2})" .
  gw2;gw3;gw4

  scpr ${version}.html 7.0 nboldt@wallace.redhat.com:/mnt/devstudio/earlyaccess/

4. Update https://devstudio.jboss.com/updates/7.0*/devstudio-directory.xml to point at new discovery jar(s) from staging.

## TODO for CR1 and GA: VERIFY CONTENTS OF DISCOVERY JAR ARE CORRECTLY POINTING AT 
#  7.0 for /7.0/
#  7.0-development for /7.0-development/
#  7.0-staging for /7.0-staging/

  version=7.0.0.GA
  SRC_SITE=7.0-staging
  DESTSITE=7.0-development # or 7.0/ for a GA release

  topic="release-${version}";branch=master; gw1

  # check in / sync changes
  scpr ~/truu/devstudio.jboss.com/updates/${SRC_SITE}/* ~/truu/devstudio.jboss.com/updates/${DESTSITE}/

  cd ~/truu/devstudio.jboss.com/updates/${DESTSITE}/discovery/
  #git rm -f com.jboss.jbds.central.discovery_*.jar
  wget -q -nc http://www.qa.jboss.com/binaries/RHDS/discovery/development/${version}/devstudio-directory.xml
  newJar=$(cat devstudio-directory.xml | grep entry | sed -e "s#.\+plugins#plugins#g" | sed -e "s#\.jar.\+#.jar#g"); echo $newJar
  wget -q -nc http://www.qa.jboss.com/binaries/RHDS/discovery/development/${version}/${newJar}
  newJar=${newJar/plugins/discovery}; echo $newJar
  rm -f ~/truu/devstudio.jboss.com/updates/${DESTSITE}/discovery/devstudio-directory.xml

  # update XML
  cd ~/truu/devstudio.jboss.com/updates/${DESTSITE}/
  sed -i -e "s#discovery/com.jboss.jbds.central.discovery_.\+\.jar#${newJar}#g" devstudio-directory.xml
 
  unzip -q -d ~/truu/devstudio.jboss.com/updates/${DESTSITE}/${newJar}{_,}
  pushd ~/truu/devstudio.jboss.com/updates/${DESTSITE}/${newJar}_ >/dev/null 

  # IF THIS IS pre-GA, ensure that your plugin points to the STAGING URL, not the RELEASE one:
  sed -i "s#https://devstudio.jboss.com/updates/7.0-staging/central/core/#https://devstudio.jboss.com/updates/7.0-development/central/core/#g" plugin.xml
  sed -i "s#https://devstudio.jboss.com/updates/7.0/central/core/#https://devstudio.jboss.com/updates/7.0-development/central/core/#g" plugin.xml

  # IF THIS IS GA, ensure that your plugin points to the RELEASE URL, not the STAGING one:
  #sed -i "s#https://devstudio.jboss.com/updates/7.0-staging/central/core/#https://devstudio.jboss.com/updates/7.0/central/core/#g" plugin.xml
  #sed -i "s#https://devstudio.jboss.com/updates/7.0-development/central/core/#https://devstudio.jboss.com/updates/7.0/central/core/#g" plugin.xml

  zip -u ~/truu/devstudio.jboss.com/updates/${DESTSITE}/${newJar} plugin.xml
  popd >/dev/null
  rm -fr ~/truu/devstudio.jboss.com/updates/${DESTSITE}/${newJar}_

  # check in / sync changes
  ga ${newJar}; stat .
  gd .

  cd ~/truu/devstudio.jboss.com/updates/
  ga ${DESTSITE}
  ci "release ${version} from ${SRC_SITE} to ${DESTSITE}" . 
  gw2;gw3;gw4

  # push both staging and development folders to wallace
  scpr ~/truu/devstudio.jboss.com/updates/${DESTSITE} ~/truu/devstudio.jboss.com/updates/${SRC_SITE} $WALL/updates/

5. Fix file permissions on wallace (pull from dev01):

  ssh nboldt@wallace "
    chmod -R g+w       /mnt/devstudio/updates/7.0-staging /mnt/devstudio/updates/7.0-development /mnt/devstudio/earlyaccess 2>/dev/null;
    chgrp -R devstudio /mnt/devstudio/updates/7.0-staging /mnt/devstudio/updates/7.0-development /mnt/devstudio/earlyaccess 2>/dev/null
  "

6. After 30-60 mins, review Early Access site:

  https://devstudio.jboss.com/earlyaccess/

7. Tag Git
  # if not already cloned, the do this:
  git clone https://github.com/jbdevstudio/jbdevstudio-product
  git clone https://github.com/jbdevstudio/jbdevstudio-ci
  git clone https://github.com/jbdevstudio/jbdevstudio-website
  git clone https://github.com/jbdevstudio/jbdevstudio-artwork
  git clone https://github.com/jbdevstudio/jbdevstudio-devdoc

  # TODO: make sure this actually works
  jbt_branch=jbosstools-4.1.x
  version=7.0.0.GA
  for d in product ci website artwork devdoc; do
    echo "====================================================================="
    echo "Tagging jbdevstudio-${d} from branch ${jbt_branch} as tag ${version}..."
    pushd ~/truu/jbdevstudio-${d}
    git stash
    git pull origin
    git fetch -t -p
    git checkout ${jbt_branch} && git tag -f jbdevstudio-${version} && git push origin jbdevstudio-${version}
    echo ">>> https://github.com/jbdevstudio/jbdevstudio-${d}/tree/jbdevstudio-${version}"
    popd >/dev/null 
    echo "====================================================================="
    echo ""
    git checkout master; git stash pop
  done

8. Commit updates to release guide (including this document):

  version=7.0.0.GA
  cd ~/truu/doc/release_guide
  topic="release-${version}";branch=master; gw1
  ci "update release guide for ${version}" *2013*JBDS*
  g2;gw3;gw4

9. Move installers from "a" or "b" folder to base folder; purge old stuff from OLD/ folder\

  ssh to dev01.mw.lab.eng.bos.redhat.com, sudo to hudson user, then

  cd ~/RHDS/builds/development/
  mv 7.0.0.GAx.installer OLD/
  mv 7.0.0.GAx.installer 7.0.0.GA.installer
  # repeat for updates/development and discovery/development

  #TODO: add note abouut also renaming/moving update and discovery sites

10. Update Marketplace entry (CR1 -> GA)


11. Send email

== Email Template -- send two emails ==

1. To:
"jbosstools-dev@lists.jboss.org" <jbosstools-dev@lists.jboss.org>

2. To:
jbds-pm-list <jbds-pm-list@redhat.com>
"external-exadel-list@redhat.com" <external-exadel-list@redhat.com>
jboss-announce@redhat.com (optional for major milestones/releases)

version=7.0.0.GA
version2=7.0.0.GA # a, b, c...
echo "
Subject: 

JBDS ${version} on Early Access

Body:


JBDS ${version} Early Access installers are now available!

https://devstudio.jboss.com/earlyaccess/

Note that bits may take a while to replicate from our staging server to publication. Please allow at least an hour before attempting to download them - if the page above still shows the previous milestone instead of ${version}, try again later.

--

JBoss Central

JBDS Central should be looking to this URL to resolve content listed on the Software/Update tab (can be changed in studio/jbdevstudio.ini):

  -Djboss.discovery.directory.url=https://devstudio.jboss.com/updates/7.0-development/devstudio-directory.xml
       -Djboss.discovery.site.url=https://devstudio.jboss.com/updates/7.0-development/

--

Eclipse Marketplace

https://marketplace.eclipse.org/content/red-hat-jboss-developer-studio-kepler

--

Schedule / Upcoming Releases:

https://issues.jboss.org/browse/JBIDE#selectedTab=com.atlassian.jira.plugin.system.project%3Aversion2s-panel

"

== Email Template -- announce internally for push to CSP ==

# To:
# jbds-pm-list <jbds-pm-list@redhat.com>
# release-engineering@redhat.com

# Cc: 
# Chris O'Brien <cobrien@redhat.com>
# Len DiMaggio <ldimaggi@redhat.com>
# Michelle Murray <mmurray@redhat.com>
# Jiri Pallich <jpallich@redhat.com>

version=7.0.0.GA
version2=7.0.0.GA # a, b, c...
echo "
Subject: 

JBDS ${version} available for push to CSP staging server

Body:

JBDS ${version} (renamed from ${version2}) is available to push to CSP staging server, for subsequent smoke test & review by QE.

Please include these 4 files:

jbdevstudio-product-eap-universal-${version}-*.jar
jbdevstudio-product-universal-${version}-*.jar 
jbdevstudio-product-Update-${version}-*.zip
jbdevstudio-product-sources-${version}-*.zip

Content is here:

http://www.qa.jboss.com/binaries/RHDS/builds/development/${version2}.installer/

When pushed, please reply to this thread so that QE can review it for push to production.

Thanks in advance,

"
